# yaml-language-server: $schema=https://json.schemastore.org/github-workflow.json

name: CI

permissions:
    contents: read

on:
    push:
    pull_request:
        types: [opened, reopened]

env:
    FFMPEG_VERSION: 7.1.1
    PYTHON_VERSION: 3.13
    POETRY_VERSION: 1.8.5

defaults:
    run:
        shell: bash

jobs:
    test:
        strategy:
            fail-fast: false
            matrix:
                python-version: ["3.8", "3.9", "3.10", "3.11", "3.12", "3.13"]
                os: [ubuntu-latest, windows-latest]

        env:
            TOXENV: ${{ matrix.python-version }}

        runs-on: ${{ matrix.os }}

        steps:
            - uses: actions/checkout@v4

            - name: Install ffmpeg & other dependencies on Ubuntu
              if: matrix.os == 'ubuntu-latest'
              run: |
                  sudo apt update
                  sudo apt install -y ffmpeg

            - name: Setup FFMPEG Environment Variables
              id: ffmpeg-env-setup
              # pipx default home and bin dir are not writable by the cache action
              # so override them here and add the bin dir to PATH for later steps.
              run: |
                  PATH_SEP="${{ !startsWith(runner.os, 'windows') && '/' || '\\' }}"
                  echo "PATH_SEP=${PATH_SEP}" >> $GITHUB_ENV

                  ffmpeg_dir="${{ github.workspace }}${PATH_SEP}ffmpeg_cache"

                  echo "ffmpeg-cache-path=${ffmpeg_dir}" >> $GITHUB_OUTPUT
                  echo "$ffmpeg_dir" >> $GITHUB_PATH

            - name: Cache FFMPEG
              uses: actions/cache@v4
              with:
                  path: ${{ steps.ffmpeg-env-setup.outputs.ffmpeg-cache-path }}
                  key: ${{ runner.os }}-ffmpeg

            - name: Install ffmpeg & other dependencies on Windows
              if: matrix.os == 'windows-latest'
              run: |
                  ffmpeg_win_version=$(curl -L https://www.gyan.dev/ffmpeg/builds/release-version 2> /dev/null | cut -d "-" -f 1)
                  ffmpeg_dir="${{ steps.ffmpeg-env-setup.outputs.ffmpeg-cache-path }}"

                  echo "$ffmpeg_dir" >> "$GITHUB_PATH"

                  # Only install if ffmpeg is not available
                  if ! $(ffmpeg -version >/dev/null 2>&1) ; then
                    win32_url="https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-full.7z"
                    win32_temp_archive="${{ github.workspace }}\ffmpeg-release-full.7z"

                    curl -L "$win32_url" -o "$win32_temp_archive"
                    mkdir "$ffmpeg_dir" || true

                    7z e "$win32_temp_archive" "-o$ffmpeg_dir" "**\bin\ffmpeg.exe" \
                        "**\bin\ffprobe.exe" "**\LICENSE" "**\README.txt"

                    rm -rf "$win32_temp_archive"
                  fi

                  echo "ffmpeg-cache-path=${ffmpeg_dir}" >> $GITHUB_OUTPUT
                  echo "ffmpeg-version=${ffmpeg_win_version}" >> $GITHUB_OUTPUT

            - name: Setup Pipx Environment Variables
              id: pipx-env-setup
              # pipx default home and bin dir are not writable by the cache action
              # so override them here and add the bin dir to PATH for later steps.
              run: |
                  PATH_SEP="${{ !startsWith(runner.os, 'windows') && '/' || '\\' }}"
                  echo "PATH_SEP=${PATH_SEP}" >> $GITHUB_ENV

                  PIPX_CACHE="${{ github.workspace }}${PATH_SEP}pipx_cache"
                  echo "pipx-cache-path=${PIPX_CACHE}" >> $GITHUB_OUTPUT
                  echo "pipx-version=$(pipx --version)" >> $GITHUB_OUTPUT
                  echo "PIPX_HOME=${PIPX_CACHE}${PATH_SEP}home" >> $GITHUB_ENV
                  echo "PIPX_BIN_DIR=${PIPX_CACHE}${PATH_SEP}bin" >> $GITHUB_ENV
                  echo "PIPX_MAN_DIR=${PIPX_CACHE}${PATH_SEP}man" >> $GITHUB_ENV
                  echo "${PIPX_CACHE}${PATH_SEP}bin" >> $GITHUB_PATH

            - name: Cache Pipx
              id: cache-pipx
              uses: actions/cache@v4
              with:
                  path: ${{ steps.pipx-env-setup.outputs.pipx-cache-path }}
                  key: ${{ runner.os }}-python_${{ env.PYTHON_VERSION }}-pipx_${{ steps.pipx-env-setup.outputs.pipx-version }}-poetry_${{ env.POETRY_VERSION }}

            - name: Install Poetry & Tox
              if: steps.cache-pipx.outputs.cache-hit != 'true'
              run: |
                  pipx install poetry==${{ env.POETRY_VERSION }}
                  pipx install tox

            - name: Setup Python ${{ matrix.python-version }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ matrix.python-version }}
                  cache: poetry

            - name: Setup Tox Bnvironment Variables
              id: tox-env-setup
              # pipx default home and bin dir are not writable by the cache action
              # so override them here and add the bin dir to PATH for later steps.
              run: |
                  TOX_CACHE="${{ github.workspace }}${{ env.PATH_SEP }}.tox"
                  echo "tox-cache-path=${TOX_CACHE}" >> $GITHUB_OUTPUT

            - name: Cache Tox
              id: cache-tox
              uses: actions/cache@v4
              with:
                  path: ${{ steps.tox-env-setup.outputs.tox-cache-path }}
                  key: ${{ runner.os }}-python_${{ matrix.python-version }}-pipx_${{ steps.pipx-env-setup.outputs.pipx-version }}-poetry_${{ env.POETRY_VERSION }}-pyproject_${{ hashFiles('pyproject.toml') }}

            - name: Run tox
              run: |
                  tox --discover $(which python)

    lint:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Setup Pipx Environment Variables
              id: pipx-env-setup
              # pipx default home and bin dir are not writable by the cache action
              # so override them here and add the bin dir to PATH for later steps.
              run: |
                  PATH_SEP="${{ !startsWith(runner.os, 'windows') && '/' || '\\' }}"

                  PIPX_CACHE="${{ github.workspace }}${PATH_SEP}pipx_cache"
                  echo "pipx-cache-path=${PIPX_CACHE}" >> $GITHUB_OUTPUT
                  echo "pipx-version=$(pipx --version)" >> $GITHUB_OUTPUT
                  echo "PIPX_HOME=${PIPX_CACHE}${PATH_SEP}home" >> $GITHUB_ENV
                  echo "PIPX_BIN_DIR=${PIPX_CACHE}${PATH_SEP}bin" >> $GITHUB_ENV
                  echo "PIPX_MAN_DIR=${PIPX_CACHE}${PATH_SEP}man" >> $GITHUB_ENV
                  echo "${PIPX_CACHE}${PATH_SEP}bin" >> $GITHUB_PATH

            - name: Cache Pipx
              id: cache-pipx
              uses: actions/cache@v4
              with:
                  path: ${{ steps.pipx-env-setup.outputs.pipx-cache-path }}
                  key: ${{ runner.os }}-python_${{ env.PYTHON_VERSION }}-pipx_${{ steps.pipx-env-setup.outputs.pipx-version }}-poetry_${{ env.POETRY_VERSION }}

            - name: Install Poetry & Tox
              if: steps.cache-pipx.outputs.cache-hit != 'true'
              run: |
                  pipx install poetry==${{ env.POETRY_VERSION }}
                  pipx install tox

            - name: Setup Python ${{ env.PYTHON_VERSION }}
              uses: actions/setup-python@v5
              with:
                  python-version: ${{ env.PYTHON_VERSION }}
                  cache: poetry

            - name: Setup Tox Bnvironment Variables
              id: tox-env-setup
              # pipx default home and bin dir are not writable by the cache action
              # so override them here and add the bin dir to PATH for later steps.
              run: |
                  TOX_CACHE="${{ github.workspace }}${{ env.PATH_SEP }}.tox"
                  echo "tox-cache-path=${TOX_CACHE}" >> $GITHUB_OUTPUT

            - name: Cache Tox
              id: cache-tox
              uses: actions/cache@v4
              with:
                  path: ${{ steps.tox-env-setup.outputs.tox-cache-path }}
                  key: ${{ runner.os }}-python_${{ env.PYTHON_VERSION }}-pipx_${{ steps.pipx-env-setup.outputs.pipx-version }}-poetry_${{ env.POETRY_VERSION }}-pyproject_${{ hashFiles('pyproject.toml') }}

            - name: Check Ruff (Lint & Format) & mypy
              if: always()
              run: tox -p -e lint,format,mypy
